
# Использование отладки для разбора логики работающей программы.

Бывают ситуации когда нужно работать с чужим кодом с целью его дальнейшей поддержки - внесение новых функций или исправления  работы старых. 

Иногда начинающие разработчики пишут совершенно неразборчивый код, используют неудачные названия для переменных (они не передают назначения/смысл переменных) или используют "магические числа" - литералы со значениями которые неочевидны - все это не улучшает читабельность кода.

В качестве примера возьмем пример исходного кода который выводит таблицу умножения в таком виде

```
2 x 2= 4        3 x 2= 6        4 x 2= 8        5 x 2= 10
2 x 3= 6        3 x 3= 9        4 x 3= 12       5 x 3= 15
2 x 4= 8        3 x 4= 12       4 x 4= 16       5 x 4= 20
2 x 5= 10       3 x 5= 15       4 x 5= 20       5 x 5= 25
2 x 6= 12       3 x 6= 18       4 x 6= 24       5 x 6= 30
2 x 7= 14       3 x 7= 21       4 x 7= 28       5 x 7= 35
2 x 8= 16       3 x 8= 24       4 x 8= 32       5 x 8= 40
2 x 9= 18       3 x 9= 27       4 x 9= 36       5 x 9= 45

6 x 2= 12       7 x 2= 14       8 x 2= 16       9 x 2= 18
6 x 3= 18       7 x 3= 21       8 x 3= 24       9 x 3= 27
6 x 4= 24       7 x 4= 28       8 x 4= 32       9 x 4= 36
6 x 5= 30       7 x 5= 35       8 x 5= 40       9 x 5= 45
6 x 6= 36       7 x 6= 42       8 x 6= 48       9 x 6= 54
6 x 7= 42       7 x 7= 49       8 x 7= 56       9 x 7= 63
6 x 8= 48       7 x 8= 56       8 x 8= 64       9 x 8= 72
6 x 9= 54       7 x 9= 63       8 x 9= 72       9 x 9= 81
```


# Исходные коды

## Ссылки

Оригинал

https://github.com/konstantine2121/debug_notes/blob/main/src/DebugNotesExamples/Example_2_Original/Program.cs

Отладка(Рефакторинг)

https://github.com/konstantine2121/debug_notes/blob/main/src/DebugNotesExamples/Example_2_Debug/Program.cs

Листинг оригинала

```cs
namespace Example_2_Original
{
    internal class Program
    {
        static void Main(string[] args)
        {
            int i = 2, j = 1, z = 0, ogri = 0, ij = 1;

            while (j < 10)
            {
                while (i < ogri)
                {
                    z = i * j;
                    Console.Write("{0} x {1}= {2}\t", i, j, z);
                    ++i;

                    ++ij;
                }

                if (ij < 33)
                {
                    ogri = 6;
                    Console.WriteLine();
                    j++;
                    i = 2;
                }
                else
                {
                    ogri = 10;
                    Console.WriteLine();
                    j++;
                    i = 6;
                    if (ij == 33)
                    {
                        Console.WriteLine();
                        j = 2;
                    }
                }
            }

            Console.ReadKey();
        }
    }
}

```


# Начало отладки

## Визуальная оценка кода 

**Переменные**

Все переменные имеют неочевидные названия

```
i, j, z, orgi, ij
```

**Литералы**

```
10, 33, 6, 2
```

Являются магическими переменными - ибо не ясно что эти значения обозначают, более того они используются в разных местах программы в разных обстоятельствах.

## Первая точка останова

Ставим точку останова в начале программы и все значения интересующих нас переменных закрепляем в окне IDE

![](attachments/Pasted%20image%2020240317223259.png)

Начинаем обход программы с помощью пошаговой отладки - клавиша F10

Продолжая отладку - замечаем некоторые нюансы работы приложения

![](attachments/Pasted%20image%2020240317224959.png)

Например
```cs
z = i * j;
Console.Write("{0} x {1}= {2}\t", i, j, z);
```

i = 2; 
j = 2
z = 2 * 2

То есть данные переменные используются непосредственно для рассчетов очередной операции умножения и вывода ее на экран.

Сделаем предположение, что переменная z нужна только в блоке кода

```cs
while (i < ogri)
{
    z = i * j;
    Console.Write("{0} x {1}= {2}\t", i, j, z);
    ++i;

    ++ij;
}
```

Проверяем это предположение - наводим курсор мыши на нее и нажимаем ПКМ, в открывшемся контекстном меню мы выбираем пункт найти все ссылки

![](attachments/Pasted%20image%2020240317225511.png)

IDE должна отобразить окно Ссылки

![](attachments/Pasted%20image%2020240317225944.png)

в нем видны строки в программе где используются данная переменная - стоит обратить внимание как на контекст/ код - так и на значение в столбце **Строка** 
У нас z используется только на 13 и на 14 строке.

## Первый шаг по рефакторингу (i, j, z)

Переименовываем переменные i, j, z в firstMultiplier, secondMultiplier, multiplicationResult соответственно.
Кроме того, переменную можем объявить непосредственно в месте использования


```cs
int firstMultiplier = 2, secondMultiplier = 1, ogri = 0, ij = 1;

while (secondMultiplier < 10)
{
    while (firstMultiplier < ogri)
    {
        int multiplicationResult = firstMultiplier * secondMultiplier;
        Console.Write("{0} x {1}= {2}\t", firstMultiplier, secondMultiplier, multiplicationResult);
        ++firstMultiplier;

        ++ij;
    }
```

После изменений фрагмент кода выглядит вот так.

## Второй шаг по рефакторингу (ij)

Также на глаза попадается строка

```cs
++ij;
```

которая вызывается сразу после вывода информации об умножении на экран

проверим, что это значения изменяется только в этом месте ("Найти все ссылки")

![](attachments/Pasted%20image%2020240317235018.png)

По использованию видно что только 17 строка изменяет значение переменной, а в 2х других строках только чтение значения.

Исходя из контекста, можем предположить что в переменной **ij** храниться значение, сколько раз происходит вывод в консоль операции умножения

Переименовываем **ij** в **outputCounter**.

## Продолжаем исследовать код

В настоящий момент он имеет вот такой вид

```cs
static void Main(string[] args)
{
    int firstMultiplier = 2, secondMultiplier = 1, ogri = 0, outputCounter = 1;

    while (secondMultiplier < 10)
    {
        while (firstMultiplier < ogri)
        {
            int multiplicationResult = firstMultiplier * secondMultiplier;

            Console.Write("{0} x {1}= {2}\t", firstMultiplier, secondMultiplier, multiplicationResult);
            
            ++firstMultiplier;
            ++outputCounter;
        }

        if (outputCounter < 33)
        {
            ogri = 6;
            Console.WriteLine();
            secondMultiplier++;
            firstMultiplier = 2;
        }
        else
        {
            ogri = 10;
            Console.WriteLine();
            secondMultiplier++;
            firstMultiplier = 6;
            if (outputCounter == 33)
            {
                Console.WriteLine();
                secondMultiplier = 2;
            }
        }
    }

    Console.ReadKey();
}
```

## Работа с окном "Контрольные значения"

### Добавление переменных для отслеживания

Для удобства наблюдения добавим все интересующие нас переменные в контрольные значения

Для этого во время отладки нужно навести курсор на интересующую переменную нажать ПКМ и в контекстном меню выбрать "Добавить контрольное значение"

![](attachments/Pasted%20image%2020240319000355.png)
После этого значение этой переменной должно отобразиться в окне "Контрольные значения 1"

![](attachments/Pasted%20image%2020240319000544.png)



### Где найти
Обычно VS сама делает данное окно активным и выводит его на передний план, но это окно также можно отобразить самому

**Отладка -> Окна -> Контрольные значения -> Контрольные значения 1**

![](attachments/Pasted%20image%2020240319000709.png)

Добавим все интересующие нас переменные для отслеживания

```
firstMultiplier secondMultiplier ogri outputCounter multiplicationResult
```

![](attachments/Pasted%20image%2020240319001423.png)


Как мы видим для переменной multiplicationResult выводится ошибка, 

| Имя                  | Значение                                                                    | Тип |
| -------------------- | --------------------------------------------------------------------------- | --- |
| multiplicationResult | error CS0103: Имя "multiplicationResult" не существует в текущем контексте. |     |

Если посмотреть на желтую стрелку - то она указывает на строку 13, а переменная multiplicationResult объявляется только на 16 строке.

Нажмем пару раз F10

![](attachments/Pasted%20image%2020240319001716.png)

Ошибка пропала

| Имя                  | Значение | Тип |
| -------------------- | -------- | --- |
| multiplicationResult | 0        | int |

Нажмем пару раз F10

![](attachments/Pasted%20image%2020240319001819.png)

||Имя|Значение|Тип|
|---|---|---|---|
||firstMultiplier|2|int|
||secondMultiplier|2|int|
||multiplicationResult|4|int|

И мы замечаем что ее значение изменилось на 4

### Добавление произвольного кода в окно контрольных значений

Если присмотреться - то на последней строке таблицы виднеется какая то надпись

![](attachments/Pasted%20image%2020240319002028.png)

Расширим столбец **Имя**, чтобы ее прочитать

![](attachments/Pasted%20image%2020240319002146.png)

```
Добавить  элемент в контрольное значение
```

Если по данной строке щелкнуть 2 раза мышью - то надпись пропадет  и мы сможем набрать текст

![](attachments/Pasted%20image%2020240319002311.png)

Наберем `2 * 2`

![](attachments/Pasted%20image%2020240319002415.png)

Видим, что среда вычислила результат выражения и отобразила его в столбце Значение

Также мы можем набирать 


----

| Навигация                 |                                             |                           |
| ------------------------- | ------------------------------------------- | ------------------------- |
| [example_1](example_1.md) | [К списку примеров](debug_examples_list.md) | [example_3](example_3.md) |
